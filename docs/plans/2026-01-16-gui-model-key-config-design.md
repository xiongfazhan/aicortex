# GUI 配置模型与 API Key 设计文档

## 目标
为应用提供 GUI 配置入口，支持多供应商模型与 API Key 管理，并可在会话内切换引擎（Claude/opencode）与模型，保证可用性、安全性与清晰的错误反馈。

## 决策摘要
- 配置存储：非敏感配置写 SQLite（主）+ JSON 导入导出；Key 优先 Keychain，失败回退为本地加密存储。
- 供应商：Anthropic、Minimax、ChatGLM、Gemini、NVIDIA NIM，支持自定义供应商。
- 模型列表：通过供应商接口拉取，缓存 TTL=24h；失败时使用缓存并允许手动输入。
- 会话级选择：供应商/模型/引擎为会话级别；切换默认“软切换”（仅文本上下文），可选“硬重置”。
- 校验：保存时必须“拉取模型 + 最小请求”双校验通过。
- 引擎：Claude 与 opencode 可切换；非 Anthropic 走 opencode。
- opencode：单例 server + 多会话，内置 CLI，自动更新稳定 release/tag。

## 架构与组件
新增两个 UI 模块与一组后台服务：
- 侧边栏“设置”页：供应商列表、Key 管理、模型拉取/缓存、导入/导出。
- 会话设置面板：引擎切换、供应商/模型选择、工作目录选择（文件选择器+手输）。
- 后台服务层：Keychain 读写、模型拉取与缓存、配置持久化、opencode server 管理。

引擎层保持 Claude Code 现有路径；opencode 通过 `@opencode-ai/sdk` 与内置 CLI 集成。应用启动或首次使用时启动单例 opencode server，并用 `OPENCODE_CONFIG_CONTENT` 注入配置；客户端通过 `createOpencodeClient({ baseUrl })` 调用，使用 SDK session 隔离会话。

## 数据流
1) 设置页保存供应商与 Key：先执行校验（模型拉取 + 最小请求）。  
2) 校验通过：Key 写入 Keychain；非敏感配置写入 SQLite，同时更新 JSON 导出缓存。  
3) 会话选择引擎与模型：若为 opencode，则复用单例 server 并创建 session。  
4) 会话内切换：默认软切换（仅注入纯文本上下文）；可选硬重置开启新话题。  
5) 模型列表：优先使用缓存，过期则刷新；失败回退缓存并允许手动模型 ID。

## 配置结构（概念）
- `providers`: 供应商列表（含 Base URL、模型列表缓存与 TTL、显示名）。
- `sessions`: 会话级设置（engine/provider/model/directory）。
- `keys`: Key 索引（providerId -> keyName/keyRef，含 Keychain 或加密存储标记）。
- `export`: JSON 仅含非敏感字段，导入时做 schema 校验。

## 错误处理
- opencode server 启动失败：提示原因并提供“重试/重新安装/切换 Claude”。
- Keychain 失败：提示并允许启用本地加密存储回退。
- 模型拉取失败：回退缓存并允许手动输入模型 ID。
- 校验失败：区分鉴权/网络/Base URL 错误，提示明确原因。
- 切换失败：回滚到切换前的引擎与模型配置。

## UI 展示
- 会话顶部状态条：显示引擎、供应商与模型。
- 消息卡片头部：显示该消息实际使用的引擎/供应商/模型。
- 设置页：供应商分组 + 搜索，模型列表支持刷新与状态提示。

## UI/UX 细节（对齐 Claude Desktop）
### 设置页布局与信息密度
设置入口在侧边栏底部，主区域采用“左列表 + 右详情”的主从结构。左侧供应商列表支持搜索与状态徽标（已验证/未验证/错误），显示当前默认模型；右侧以卡片分组展示基础信息、认证、模型与高级项（高级默认折叠）。底部固定操作区，仅保留一个主按钮（“保存并验证”）与一个次按钮（“取消/重置”），减少寻找入口的成本。错误提示以内联形式贴近字段，成功提示使用轻量 toast，整体留白与节奏贴近 Claude Desktop。

### 供应商/模型选择与校验流程
模型选择使用可搜索下拉框，顶部展示“推荐/最近使用”，并以标签展示模型属性（推理/多模态/长上下文）。修改 Key 或 Base URL 后表单标记为“未验证”，主按钮禁用。点击“保存并验证”后，先拉取模型列表，再发最小请求验证；进度以内联步骤条展示。失败时提供可行动作文案（检查 Base URL/权限/网络），拉取失败自动回退缓存并允许手动输入模型 ID。

### 引擎切换与历史处理
会话设置面板中提供引擎切换（Claude/OpenCode）与供应商/模型选择。切换时弹出轻量确认：默认“软切换（推荐）”（仅注入纯文本历史，不重放工具调用），次选“硬重置（新话题）”。切换进度显示在会话顶部状态条，可取消；失败则回滚到切换前配置，并提供“重试/保持当前/查看详情”。

### 提示样式与文案语气
优先“就地反馈 + 轻量 toast”。错误信息短、可操作，避免工程化术语；危险操作使用明确按钮层级但不滥用红色。确认弹窗尽量少，内容简短且只给下一步。整体语气与 Claude Desktop 一致：克制、明确、低打断。

## 测试策略
- 单测：配置持久化、Keychain 读写封装、缓存 TTL 判断。
- 集成/端到端：保存校验流程、模型拉取失败回退、会话切换与软/硬切换分支。
- 回归：Claude 引擎流程保持原行为，权限与日志不回退。

## 风险与缓解
- opencode CLI 内置与更新：明确版本源为稳定 release/tag，更新失败则回退旧版本。
- 多会话并发：单例 server 需验证会话隔离与并发能力，若不满足则回退为受控进程池。
- 数据安全：Key 不出 Keychain，导出/导入不包含敏感信息。
